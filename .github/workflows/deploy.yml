# Workflow для автоматического деплоя приложения на VPS сервер
# Запускается после успешного выполнения workflow "Release image"
name: Deploy to VPS

# Триггер запуска workflow - после завершения workflow "Release image"
on:
  workflow_run:
    workflows: ["Release image"]
    types:
      - completed

jobs:
 deploy:
    # Выполняется только если предыдущий workflow завершился успешно
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      # Шаг 1: Настройка SSH агента для подключения к серверу
      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      # Шаг 2: Выполнение удаленного скрипта деплоя на сервере
      - name: Execute remote deployment script
        uses: appleboy/ssh-action@v1.2.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          script: |
            cd /root/personal_website
            bash personal_website/scripts/server/update.sh
