# Опубликовать образ контейнера основного сервиса в несколько реестров:
# - GitHub Container registry
# - Docker Hub
name: Publish Docker image

# Выполняется после того, как закрыт Pull Request в ветку "main",
# если изменения в файлах не касаются только путей из перечня исключений.
on:
  pull_request:
    types:
      - closed
    branches:
      - 'main'
    paths-ignore:
      - 'docs/**'
      - 'nginx/**'
      - '.vscode/**'
  workflow_dispatch:

env:
  TEST_IMAGE_NAME: ghcr.io/${{ github.repository }}:test-latest
  GITHUB_RELEASE_IMAGE_NAME: ghcr.io/${{ github.repository }}:latest
  DOCKER_RELEASE_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/personal-website:latest

jobs:

  retag_and_push_image:
    # Запускается только если PR был смержен или workflow запущен вручную.
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    name: Retag and push tested Docker image to Docker Hub and GHCR
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Получение тестового образа из GHCR
      - name: Pull test image from GHCR
        run: |
          docker pull ${{ env.TEST_IMAGE_NAME }}

      # Перетегирование тестового образа как "latest" для GHCR
      - name: Tag image as latest for GHCR
        run: |
          docker tag ${{ env.TEST_IMAGE_NAME }} ${{ env.GITHUB_RELEASE_IMAGE_NAME }}

      # Перетегирование тестового образа для Docker Hub
      - name: Tag image for Docker Hub
        run: |
          docker tag ${{ env.TEST_IMAGE_NAME }} ${{ env.DOCKER_RELEASE_IMAGE_NAME }}

      # Публикация образа с тегом "latest" в GHCR
      - name: Push image to GHCR with latest tag
        run: |
          docker push ${{ env.GITHUB_RELEASE_IMAGE_NAME }}

      # Публикация образа в Docker Hub
      - name: Push image to Docker Hub
        run: |
          docker push ${{ env.DOCKER_RELEASE_IMAGE_NAME }}

      # Удаление тестового тега из GHCR для очистки реестра
      - name: Delete test tag from GHCR
        run: |
          if docker manifest inspect ${{ env.TEST_IMAGE_NAME }} > /dev/null 2>&1; then
            docker manifest rm ${{ env.TEST_IMAGE_NAME }}
          fi
