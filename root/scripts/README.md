# Скрипты

## Описание

Приложение для управления скриптами. В данный момент доступны следующие скрипты:

- **Бэкап базы данных** - регулярный дамп базы данных PostgreSQL и отправка дампа по электронной почте администраторам.

## Структура

- `apps.py` - модуль, инициализирующий приложение.
- `models.py` - модели приложения.
- `admin.py` - отображение моделей в административном интерфейсе Django.
- `urls.py` - маршруты для запуска скриптов.
- `views.py` - функции для отображения скриптов и истории выполнения.
- `decorators.py` - декораторы для контроля за выполнением скриптов.
- `tools.py` - функции планировщика скриптов.
- `management` - подкаталог с административными командами и непосредственно скриптами.
  - `commands` - административные команды для запуска скриптов и планировщика.

## Модель данных

Для управления задачами используется две модели:

1. Скрипт (Job) - название скрипта, описание и ссылка для запуска.
2. Выполнение (Execution) - обособленный процесс выполнения скрипта.

Иными словами, скрипт - это задача, её описание и способ запуска. Выполнение - это хранение информации о состоянии выполнения задачи. У одного скрипта может быть много запусков, но один запуск может быть связан только с одним скриптом. Это взаимсовязь определена через `ForeignKey`.

## Запуск скриптов

Запустить скрипт можно несколькими способами:

1. Вручную:
    - Через браузер, перейдя по ссылке `https://<domain_name>/scripts/<slug>`.
    - CLI-командой `python manage.py <slug>` (используя виртуальное окружение проекта) - через терминал сервера.
    - CLI-командой `curl https://<domain_name>/scripts/<slug>` - через терминал иных устройств.
    - Из программного кода, используя функцию `management.call_command('<slug>')`.

2. Автоматически:
    - Используя встроенный планировщик, основанный на библиотеке APScheduler, который считывает крон-выражения из базы данных при запуске приложения и вызывает команду `suprocess.Popen(["python", "manage.py", "<slug>"])`. Встроенный планировщик должен быть запущен автоматически при загрузке системы тем методом, который предоставляет система.
    - Используя crontab для вызова каждой команды:
        - либо `curl https://<domain_name>/scripts/<slug>`,
        - либо `python manage.py <slug>`.

### Через браузер

При создании объекта "Скрипт" заполняется поле `SlugField`, который используется для создания абсолютного URL, по которому вызывается запуск скрипта. Допустим, у скрипта имеется определенный `slug`. Тогда абсолютный путь для запуска данного скрипта будет выглядеть следующим образом: `https://<domain_name>/scripts/<slug>`.

При использовании данного URL происходит вызов скрипта -> в отдельном процессе вызывается административная команда Django, название которой соответствует слагу: например, `python manage.py <slug>`. Таким образом, процесс получает доступ к контексту Django и записывает состояние выполнения скрипта в базу данных, управляемую Django. Для того, чтобы выполнение скрипта не оказывало влияние на основной процесс Django, административная команда вызывается через `suprocess.Popen`:

    suprocess.Popen(["python", "manage.py", "<slug>"])

### Через терминал сервера

Команду `python manage.py <slug>` можно ввести вручную в терминале сервера. Этот метод удобно применять в том случае, если на сервере настроен планировщик задач (cron, Windows Task Scheduler или альтернатива). При этом необходимо предварительно указать путь до интерпретатора Python из виртуального окружения. Это можно сделать несколькими способами:

1. Предварительно активировав виртуальное окружение.

        cd project_folder
        .venv/scripts/activate
        python manage.py <slug>

2. Вызвав скрипт через Poetry.

        cd project_folder
        poetry run python manage.py <slug>

### Через терминал клиентского ПК

Можно вызвать выполнение скрипта через curl: `curl https://<domain_name>/scripts/<slug>`. Это удобно в том случае, если планировщик задач настроен на клиентском ПК.

### Вызов команды напрямую из программного кода

Скрипт, как и любую административную команду Django, можно вызвать в программном коде через фукнцию `management.call_command('<slug>')`. При этом команда будет выполняться в синхронном режиме - т.е. выполнение основного процесса будет приостановлено до тех пор, пока не будет выполнен скрипт. Этот метод уместно использовать только в тех случаях, когда время выполнения скрипта занимает не более нескольких секунд.

## Дополнительная информация

- [django-admin and manage.py](https://docs.djangoproject.com/en/dev/ref/django-admin/)
- [How to create custom django-admin commands](https://docs.djangoproject.com/en/dev/howto/custom-management-commands/)
- [Advanced Python Scheduler](https://apscheduler.readthedocs.io/en/latest/)
