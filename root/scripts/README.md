# Скрипты

## Описание

Приложение для управления скриптами. В данный момент доступны следующие скрипты:
* **Бэкап базы данных** - регулярный дамп базы данных PostgreSQL и отправка дампа по электронной почте администраторам.

## Структура

* `apps.py` - модуль, инициализирующий приложение.
* `models.py` - модели приложения.
* `admin.py` - отображение моделей в административном интерфейсе Django.
* `urls.py` - маршруты для запуска скриптов.
* `views.py` - функции для отображения скриптов и истории выполнения.
* `scheduler.py` - планировщик скриптов, использующий библиотеку APScheduler.
* `management` - подкаталог с административными командами и непосредственно скриптами.
    * `scripts` - непосредственно скрипты.
    * `commands` - административные команды для управления запуском скриптов и сохранением состояния выполнения.

## Бизнес-логика

Для управления задачами используется две модели:
1. Скрипт (Job) - название скрипта, описание и ссылка для запуска.
2. Выполнение (Execution) - обособленный процесс выполнения скрипта.

Иными словами, скрипт - это задача, её описание и способ запуска. Выполнение - это хранение информации о состоянии выполнения задачи. У одного скрипта может быть много запусков, но один запуск может быть связан только с одним скриптом. Это взаимсовязь определена через `ForeignKey`.

При создании объекта "Скрипт" заполняется поле `SlugField`, который используется для создания абсолютного URL, по которому вызывается запуск скрипта. Допустим, у скрипта имеется определенный `slug`. Тогда абсолютный путь для запуска данного скрипта будет выглядеть следующим образом: `https://<domain_name>/scripts/<slug>`.

При использовании данного URL происходит вызов скрипта -> в отдельном процессе вызывается административная команда Django, название которой соответствует слагу: например, `python manage.py <slug>`. Таким образом, процесс получает доступ к контексту Django и записывает состояние выполнения скрипта в базу данных, управляемую Django. Для того, чтобы выполнение скрипта не оказывало влияние на основной процесс Django, административная команда вызывается через `suprocess.Popen`:

    suprocess.Popen(["python", "manage.py", "<slug>"])

Запустить скрипт можно несколькими способами:

1. Вручную:

    * Через браузер, перейдя по ссылке `https://<domain_name>/scripts/<slug>`.
    * Через CLI командой `curl https://<domain_name>/scripts/<slug>`.
    * Через CLI командой `python manage.py <slug>` (используя виртуальное окружение проекта).
    * Из программного кода, используя функцию `management.call_command('<slug>')`.

2. Автоматически:

    * Используя встроенный планировщик, основанный на библиотеке APScheduler, который считывает крон-выражения из базы данных при запуске приложения и вызывает команду `suprocess.Popen(["python", "manage.py", "<slug>"])`.
    * Используя crontab для вызова команды `curl https://<domain_name>/scripts/<slug>`, либо `python manage.py <slug>`.