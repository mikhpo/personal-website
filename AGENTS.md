# AGENTS.md

## Обзор проекта

Это персональный сайт, созданный с использованием Django. Проект включает в себя функциональность блога, фотогалерею, управление учетными записями пользователей и панель администратора.

## Команды установки

- Установить зависимости: `poetry install`
- Применить миграции: `poetry run python personal_website/manage.py migrate`
- Запустить сервер разработки: `poetry run python personal_website/manage.py runserver`
- Запустить тесты: `poetry run pytest`

## Docker Compose

- Используется для запуска приложения и его зависимостей
- Запустить приложение и все зависимости: `docker-compose up -d`
- Запустить только зависимости (базу данных и объектное хранилище): `docker-compose up -d postgres minio`
- Остановить всё приложение и зависимости: `docker-compose down`

## Структура проекта

Основные приложения Django:

- accounts: управление пользователями
- blog: система статей и комментариев
- gallery: фотогалерея
- main: главная страница и основные компоненты

Рекомендуемые паттерны:

- Использовать Class-Based Views для представлений
- Применять ModelForms для работы с формами
- Реализовать наследование шаблонов
- Создавать пользовательские менеджеры для сложных запросов к базе данных

## Специфика архитектуры

### Модели данных

- Все модели имеют менеджеры для публичных объектов (published)
- Используются слаги для URL вместо ID
- Реализована система тегов для галереи
- Модели блога связаны между собой (статьи, категории, серии, темы)

### Особенности галереи

- Используется ImageKit для генерации миниатюр
- Автоматическое извлечение EXIF данных из фотографий
- Возможность смены альбома для фотографий с перемещением файлов

### Особенности блога

- Статьи могут принадлежать нескольким категориям, сериям и темам
- Есть система комментариев
- Поддержка TinyMCE редактора для статей

## Работа с данными

- Использовать select_related и prefetch_related для сложных запросов
- Применять соответствующие типы полей при создании моделей
- Реализовывать валидацию для пользовательских данных
- Использовать сигналы Django для автоматических действий при изменениях

## Работа с файлами

### Статические файлы

- Хранятся в `staticfiles/` директории проекта
- Используются Bootstrap 5 и Bootstrap Icons
- Обслуживаются через WhiteNoise в продакшене

### Медиа файлы

- Хранятся в директории `storage/` по умолчанию
- Используется MinIO/S3 для хранения в продакшене
- Автоматическая очистка старых файлов при удалении объектов (django-cleanup)

### Управление файлами и хранением

- Для выбора файлового хранилища используется функция `select_storage()` - в тестах используется тестовое хранилище, в продакшене - стандартное

### Настройка S3 хранилища

- Проект поддерживает использование S3-совместимых хранилищ для хранения медиа файлов
- Для включения S3 хранилища необходимо установить переменную окружения `STORAGE_TYPE=s3` и запустить MinIO через Docker Compose: `docker-compose up -d minio`

## Стиль кода

- Следовать рекомендациям PEP 8
- Использовать аннотации типов во всех функциях и методах
- Писать docstrings для всех публичных классов и функций
- Использовать встроенные механизмы Django вместо самописных решений
- Генерировать HTML с помощью шаблонизатора Django
- Соблюдение максимальной длины строки 120 символов
- Весь код и комментарии в проекте написаны на русском языке
- Все docstrings следуют конвенции PEP 257
- При создании докстрингов и комментариев используй русский язык
- Названия переменных, функций и классов должны следовать стандартам Python

## Тестирование

- Запускать тесты с помощью pytest: `poetry run pytest`
- Писать unit-тесты для бизнес-логики
- Создавать интеграционные тесты для представлений
- Проверять граничные случаи и обработку ошибок
- Использовать фабрики (factory_boy или model_bakery) для генерации тестовых данных
- Используется pytest с pytest-django
- Есть фикстуры для создания тестовых данных

## Workflow разработки

- Использовать pre-commit хуки для автоматической проверки кода перед коммитом
- Запускать pre-commit вручную при необходимости: `pre-commit run --all-files`
- Использовать Taskfile для стандартных задач разработки:
  - `task runserver` - запустить сервер разработки
  - `task test` - запустить тесты
  - `task check` - выполнить статический анализ кода
  - `task migrate` - создать и применить миграции
  - `task install` - установить зависимости
- Приоритеты при разработке:
  - Сохранение существующей архитектуры и подходов
  - Соблюдение стиля кода проекта (ruff, black, isort)
  - Поддержка русскоязычной документации
  - Написание тестов для нового функционала

## Специфические инструменты проекта

### Taskfile

- Все стандартные операции доступны через task команды
- Автоматический запуск Docker контейнеров при необходимости
- Комплексные операции объединены в одну команду

### Pre-commit

- Автоматические проверки перед каждым коммитом
- Включает форматирование, линтинг, проверку типов
- Можно запустить вручную через `pre-commit run --all-files`

## Линтинг и проверки кода

- Запускать Ruff для проверки стиля кода и автоматического исправления ошибок: `poetry run ruff check --fix`
- Запускать Mypy для проверки типов: `poetry run mypy .`
- Проверять JavaScript код с помощью ESLint: `npm run lint` или `npx eslint .`
- Проверять Markdown файлы с помощью markdownlint: `npx markdownlint-cli *.md docs/*.md`
- Выполнять все проверки перед коммитом через pre-commit хуки

## Безопасность

- Проверять права доступа к представлениям
- Использовать встроенную защиту CSRF Django
- Экранировать пользовательский ввод в шаблонах
- Избегать хранения конфиденциальных данных в коде

## Документирование

- Вести техническую документацию на русском языке
- Использовать понятные имена переменных и функций
- Комментировать сложную логику в коде
- Обновлять документацию при изменении функциональности

## Особенности развертывания

- Используется Gunicorn как WSGI сервер
- Nginx для обслуживания статических файлов и проксирования
- WhiteNoise для обслуживания статики в случае отсутствия Nginx
- PostgreSQL как основная база данных
- MinIO/S3 для хранения медиа файлов

## Работа с изображениями

- Используется Pillow для обработки изображений
- ImageKit для генерации миниатюр
- Автоматическое извлечение EXIF данных
- Поддержка различных размеров изображений (thumbnail, preview)

## Цели

1. Создать функциональный персональный сайт
2. Обеспечить расширяемость и модульность
3. Поддерживать высокое качество кода
4. Предоставить полную документацию для дальнейшей разработки
