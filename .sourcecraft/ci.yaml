# Конфигурация CI/CD для SourceCraft
# Документация: https://sourcecraft.dev/portal/docs/ru/sourcecraft/operations/ci-cd

# Файл определяет процессы непрерывной интеграции и доставки для проекта personal_website
# Включает в себя тестирование, сборку Docker-образов, релиз и деплой приложения

# Настройка событий-триггеров
# Определяет при каких событиях запускать те или иные рабочие процессы
on:
  # Запуск тестов при создании или обновлении pull request
  # При открытии или изменении PR будет запущен процесс тестирования
  pull_request:
    - workflows: [test-workflow]

  # Запуск релиза при пуше в ветку main
  # При пуше в основную ветку запускается процесс релиза
  push:
    - workflows: [release-workflow]
      filter:
        branches: ["main"]


# Определение рабочих процессов
workflows:
  # Рабочий процесс для тестирования
  # Выполняет проверку кода, линтинг и запуск тестов
  test-workflow:
    # Переменные окружения для тестового процесса
    # Содержит настройки для запуска тестов и проверок кода
    env:
      # Режим отладки Django
      DEBUG: true
      # Секретный ключ Django (из секретов)
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      # Имя проекта
      PROJECT_NAME: personal_website
      # Настройки подключения к PostgreSQL для тестов
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_DB: personal_website
      # Настройки почтового сервера (из секретов)
      EMAIL_HOST_USER: ${{ secrets.EMAIL_HOST_USER }}
      EMAIL_HOST_PASSWORD: ${{ secrets.EMAIL_HOST_PASSWORD }}
      # Доменное имя сайта (из секретов)
      DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
      # Локаль для корректной работы с русским языком
      LANG: ru_RU.utf8
      # Версия Python для установки
      PYTHON_VERSION: "3.12"
      # Версия Node.js для установки
      NODE_VERSION: "latest"
    tasks:
      - name: cache-dependencies-task
        cubes:
          - name: cache-poetry
            uses: actions/setup-python@v5
            with:
              python-version: ${{ env.PYTHON_VERSION }}

          - name: install-poetry
            uses: snok/install-poetry@v1
            with:
              version: latest
              virtualenvs-create: true
              virtualenvs-in-project: true

          - name: load-poetry-cache
            uses: actions/cache@v4
            with:
              path: .venv
              key: poetry-${{ hashFiles("**/poetry.lock") }}

          - name: install-python-dependencies
            run: poetry install

          # Настройка Node.js и кэширование npm зависимостей
          - name: cache-npm
            uses: actions/setup-node@v4
            with:
              node-version: ${{ env.NODE_VERSION }}

          - name: load-npm-cache
            uses: actions/cache@v4
            with:
              path: node_modules
              key: npm-${{ hashFiles("**/package-lock.json") }}

          - name: install-node-dependencies
            run: npm install

      # Задача линтинга кода - проверяет качество кода с помощью различных линтеров
      - name: lint-task
        needs: [cache-dependencies-task]
        cubes:
          # Проверка Python кода с помощью Ruff
          - name: ruff-check
            uses: chartboost/ruff-action@v1

          # Проверка типов Python с помощью MyPy
          - name: mypy-check
            run: poetry run mypy .

          # Проверка JavaScript кода с помощью ESLint
          - name: eslint-check
            uses: eslint/action-eslint@v1
            with:
              config: .eslintrc.json

          # Проверка Markdown файлов
          - name: markdownlint-check
            uses: DavidAnson/markdownlint-cli2-action@v18
            with:
              globs: |
                *.md
                docs/**/*.md

      # Задача тестирования - запускает тесты приложения
      - name: test-task
        needs: [cache-dependencies-task]
        cubes:
          # Установка системных зависимостей, необходимых для тестов
          - name: setup-system-deps
            run: |
              sudo apt-get update
              sudo apt-get install -y wkhtmltopdf locales
              sudo localedef -i ru_RU -c -f UTF-8 -A /usr/share/locale/locale.alias ${{ env.LANG }}

          # Проверка наличия непримененных миграций Django
          - name: run-django-migrations-check
            run: poetry run python personal_website/manage.py makemigrations --dry-run --check

          # Сбор статических файлов
          - name: collect-static-files
            run: poetry run python personal_website/manage.py collectstatic --noinput

          # Запуск тестов с помощью pytest
          - name: run-pytest
            run: poetry run pytest

          # Загрузка отчета о покрытии кода тестами
          - name: upload-coverage-report
            uses: actions/upload-artifact@v4
            with:
              name: coverage-html-report
              path: htmlcov/

  # Рабочий процесс для сборки Docker-образа
  # Собирает и тестирует Docker-образ приложения
  build-workflow:
    # Переменные окружения для процесса сборки
    # Содержит настройки для сборки и тестирования Docker-образа
    env:
      # Режим отладки Django
      DEBUG: true
      # Секретный ключ Django (из секретов)
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      # Имя проекта
      PROJECT_NAME: personal_website
      # Настройки подключения к PostgreSQL
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_DB: personal_website
      # Настройки почтового сервера (из секретов)
      EMAIL_HOST_USER: ${{ secrets.EMAIL_HOST_USER }}
      EMAIL_HOST_PASSWORD: ${{ secrets.EMAIL_HOST_PASSWORD }}
      # Доменное имя сайта (из секретов)
      DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
      # Локаль для корректной работы с русским языком
      LANG: ru_RU.utf8
      # Версия Python для установки
      PYTHON_VERSION: "3.12"
      # Версия Node.js для установки
      NODE_VERSION: "latest"
      # Теги для Docker-образов
      TEST_TAG: test
      TESTED_TAG: tested
      # Полные имена Docker-образов с тегами
      TEST_IMAGE_NAME: ghcr.io/${{ repository }}:${TEST_TAG}
      TESTED_IMAGE_NAME: ghcr.io/${{ repository }}:${TESTED_TAG}
    tasks:
      # Задача сборки Docker-образа
      - name: build-image-task
        needs: [test-task]
        cubes:
          # Настройка Docker Buildx для кросс-платформенной сборки
          - name: setup-docker-buildx
            uses: docker/setup-buildx-action@v3

          # Авторизация в GitHub Container Registry
          - name: login-to-ghcr
            uses: docker/login-action@v3
            with:
              registry: ghcr.io
              username: ${{ github.actor }}
              password: ${{ secrets.GITHUB_TOKEN }}

          # Сборка и пуш тестового образа в GitHub Container Registry
          - name: build-and-push-test-image
            uses: docker/build-push-action@v6
            with:
              context: .
              file: personal_website/Dockerfile
              push: true
              tags: ${{ env.TEST_IMAGE_NAME }}

      # Задача тестирования собранного образа
      - name: test-build-task
        needs: [build-image-task]
        cubes:
          # Повторная авторизация в GitHub Container Registry
          - name: login-to-ghcr
            uses: docker/login-action@v3
            with:
              registry: ghcr.io
              username: ${{ github.actor }}
              password: ${{ secrets.GITHUB_TOKEN }}

          # Получение тестового образа для проверки
          - name: pull-test-image
            run: docker pull ${{ env.TEST_IMAGE_NAME }}

          # Пометка образа как протестированного и пуш в реестр
          - name: tag-as-tested
            run: |
              docker tag ${{ env.TEST_IMAGE_NAME }} ${{ env.TESTED_IMAGE_NAME }}
              docker push ${{ env.TESTED_IMAGE_NAME }}

  # Рабочий процесс для релиза
  # Помечает протестированный образ как релизный и пушит в реестры
  release-workflow:
    env:
      TESTED_TAG: tested
      LATEST_TAG: latest
      TESTED_IMAGE_NAME: ghcr.io/${{ repository }}:${TESTED_TAG}
      GITHUB_RELEASE_IMAGE_NAME: ghcr.io/${{ repository }}:${LATEST_TAG}
      DOCKER_RELEASE_IMAGE_NAME: ${{ repository }}:${LATEST_TAG}
    tasks:
      # Задача переименования и пуша релизного образа
      - name: retag-and-push-task
        cubes:
          # Авторизация в GitHub Container Registry
          - name: login-to-ghcr
            uses: docker/login-action@v3
            with:
              registry: ghcr.io
              username: ${{ github.actor }}
              password: ${{ secrets.GITHUB_TOKEN }}

          # Получение протестированного образа
          - name: pull-tested-image
            run: docker pull ${{ env.TESTED_IMAGE_NAME }}

          # Переименование и пуш образа в GHCR как latest
          - name: retag-for-ghcr
            run: |
              docker tag ${{ env.TESTED_IMAGE_NAME }} ${{ env.GITHUB_RELEASE_IMAGE_NAME }}
              docker push ${{ env.GITHUB_RELEASE_IMAGE_NAME }}

          # Авторизация в Docker Hub
          - name: login-to-docker-hub
            uses: docker/login-action@v3
            with:
              username: ${{ secrets.DOCKER_USERNAME }}
              password: ${{ secrets.DOCKER_PASSWORD }}

          # Переименование и пуш образа в Docker Hub как latest
          - name: retag-for-docker-hub
            run: |
              docker tag ${{ env.TESTED_IMAGE_NAME }} ${{ env.DOCKER_RELEASE_IMAGE_NAME }}
              docker push ${{ env.DOCKER_RELEASE_IMAGE_NAME }}

  # Рабочий процесс для деплоя
  # Выполняет деплой приложения на production сервер
  deploy-workflow:
    # Переменные окружения для процесса деплоя
    # Содержит настройки подключения к production серверу
    env:
      # Параметры подключения к серверу (из секретов)
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
    tasks:
      # Задача деплоя приложения на VPS сервер
      - name: deploy-task
        needs: [release-workflow]
        cubes:
          # Подключение по SSH и выполнение скрипта обновления
          - name: deploy-to-vps
            uses: appleboy/ssh-action@v1.2.3
            with:
              host: ${{ env.SERVER_HOST }}
              username: ${{ env.SERVER_USER }}
              key: ${{ secrets.DEPLOY_SSH_KEY }}
              script: |
                cd /root/personal-website
                bash personal_website/scripts/server/update.sh
