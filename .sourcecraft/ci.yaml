# Конфигурация CI/CD для SourceCraft
# Функционально повторяет имеющиеся GitHub Workflow с учетом ограничения не более 3 тасок на 1 рабочий процесс

# Определение событий-триггеров для запуска рабочих процессов.
on:

  push:
    # Запускаются при пуше в любую ветку, кроме основной:
    # 1. review-workflow
    # 2. build-workflow
    - workflows: [review-workflow, build-workflow]
      filter:
        branches: ["!main", "!master"]

  # 3. release-workflow - запускается при пуше в ветку main
    - workflows: [release-workflow]
      filter:
        branches: ["main", "master"]

# Определение рабочих процессов
workflows:
  # Запускается при пуше в любую ветку, если есть открытый pull request
  review-workflow:
    # Определение переменных окружения для всего рабочего процесса
    env:
      DEBUG: "True"
      PROJECT_NAME: "personal_website"
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgres"
      POSTGRES_HOST: "localhost"
      POSTGRES_PORT: "5432"
      POSTGRES_DB: "personal_website"
      PYTHON_VERSION: "3.13"
      NODE_VERSION: "latest"
      POSTGRES_VERSION: "15"
    tasks:
      # Статический анализ и линтинг.
      - name: "lint-task"
        cubes:
          # Выполнить проверки утилитами Python
          - name: "python-check"
            image: docker.io/library/python:${PYTHON_VERSION}
            script:
              - "pip install poetry"
              - "poetry install"
              - "poetry run ruff check"
              - "poetry run mypy ."

          # Выполнить проверки утилитами Node.js
          - name: "node-check"
            image: docker.io/library/node:${NODE_VERSION}
            script:
              - "npm install"
              - "npx eslint . --ext .js,.jsx,.ts,.tsx"
              - "npx markdownlint-cli *.md docs/*.md"

      # Тестирование.
      - name: "test-task"
        cubes:
          # Запуск PostgreSQL для тестов
          - name: "start-postgres"
            image: docker.io/library/postgres:${POSTGRES_VERSION}
            env:
              POSTGRES_USER: ${POSTGRES_USER}
              POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
              POSTGRES_DB: ${POSTGRES_DB}
            script:
              - timeout 30 bash -c 'until pg_isready -U ${POSTGRES_USER}; do sleep 1; done'

          # Установка системных зависимостей
          - name: "install-system-dependencies"
            script:
              - "sudo apt-get update"
              - "sudo apt-get install -y wkhtmltopdf locales"
              - "sudo localedef -i ru_RU -c -f UTF-8 -A /usr/share/locale/locale.alias ru_RU.UTF-8"

          # Выполнить тестирование кода Python
          - name: "python-test"
            needs: ["start-postgres", "install-system-dependencies"]
            image: docker.io/library/python:${PYTHON_VERSION}
            env:
              POSTGRES_USER: ${POSTGRES_USER}
              POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
              POSTGRES_DB: ${POSTGRES_DB}
              POSTGRES_HOST: ${POSTGRES_HOST}
              POSTGRES_PORT: ${POSTGRES_PORT}
            script:
              - "pip install poetry"
              - "poetry install"
              - "poetry run python personal_website/manage.py collectstatic --noinput"
              - "poetry run python personal_website/manage.py makemigrations --dry-run --check"
              - "poetry run pytest"

          # Выполнить тестирование кода JavaScript
          - name: "node-test"
            image: docker.io/library/node:${NODE_VERSION}
            script:
              - "npm install"
              - "npm test"

  # Запускается при пуше в любую ветку, если есть открытый pull request
  build-workflow:
    tasks:
      - name: "build-application"
        cubes:
          - name: "echo-build-message"
            script:
              - "echo 'Building application...'"

  # release-workflow - запускается при пуше в ветку main
  release-workflow:
    tasks:
      - name: "create-release"
        cubes:
          - name: "echo-release-message"
            script:
              - "echo 'Creating release...'"

  # Запускается вручную
  deploy-workflow:
    tasks:
      - name: "deploy-application"
        cubes:
          - name: "echo-deploy-message"
            script:
              - "echo 'Deploying application...'"
