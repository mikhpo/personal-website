# Конфигурация CI/CD для SourceCraft
# Функционально повторяет имеющиеся GitHub Workflow с учетом ограничения не более 3 тасок на 1 рабочий процесс

# Определение событий-триггеров для запуска рабочих процессов.
on:
  pull_request:
    # Запускается при открытии предложения изменений
    - workflows: [lint-workflow, test-workflow, build-workflow]
      filter:
        target_branches: ["main", "master"]

  push:
    # Запускается при пуше не в основную ветку
    - workflows: [lint-workflow, test-workflow, build-workflow]
      filter:
        branches: ["!main", "!master"]

    # Запускается при пуше в основную ветку
    - workflows: [release-workflow]
      filter:
        branches: ["main", "master"]

# Определение рабочих процессов
workflows:
  # Статический анализ и линтинг
  lint-workflow:
    tasks:
      # Выполнить проверки утилитами Python
      - name: "python-check"
        cubes:
          - name: "ruff-mypy"
            image: docker.io/library/python:3.13-bookworm
            script:
              - echo "Установка Poetry и зависимостей проекта"
              - pip install poetry
              - poetry install
              - echo "Запуск статического анализа с помощью Ruff"
              - poetry run ruff check
              - echo "Запуск проверки типов с помощью MyPy"
              - poetry run mypy .

      # Выполнить проверки утилитами Node.js
      - name: "node-check"
        cubes:
          - name: "eslint-markdown"
            image: docker.io/library/node
            script:
              - echo "Установка зависимостей Node.js"
              - npm install
              - echo "Запуск ESLint для проверки JavaScript/TypeScript кода"
              - npx eslint . --ext .js,.jsx,.ts,.tsx
              - echo "Проверка Markdown файлов с помощью markdownlint"
              - npx markdownlint-cli *.md docs/*.md

  # Тестирование
  test-workflow:
    # Определение переменных окружения для всего рабочего процесса
    env:
      DEBUG: "True"
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      PROJECT_NAME: "personal_website"
      STORAGE_TYPE: "filesystem"
    tasks:
      # Тестирование кода Python
      - name: "python-test"
        cubes:
          - name: "pytest"
            image: docker.io/library/python:3.13-bookworm
            script:
              - echo "Обновление системы и установка необходимых пакетов"
              - apt-get update
              - apt-get install -y wkhtmltopdf locales
              - echo "Настройка локали ru_RU.UTF-8"
              - localedef -i ru_RU -c -f UTF-8 -A /usr/share/locale/locale.alias ru_RU.UTF-8
              - echo "Установка Poetry и зависимостей проекта"
              - pip install poetry
              - poetry install
              - echo "Запуск тестов Python с помощью Pytest"
              - poetry run pytest

      # Тестирование кода JavaScript
      - name: "node-test"
        cubes:
          - name: "node"
            image: docker.io/library/node
            script:
              - echo "Установка зависимостей Node.js для тестирования"
              - npm install
              - echo "Запуск тестов JavaScript с помощью npm"
              - npm test

  # Сборка и тестирование образа приложения
  build-workflow:
    # Переменные окружения для процесса сборки Docker-образа
    env:
      PROJECT_NAME: "personal_website" # Имя проекта
      SECRET_KEY: ${{ secrets.SECRET_KEY }} # Секретный ключ для Django
      TEST_TAG: "test" # Тег для тестового образа
      TESTED_TAG: "tested" # Тег для протестированного образа
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }} # Имя пользователя Docker Hub
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }} # Пароль пользователя Docker Hub
      YC_OAUTH_TOKEN: ${{ secrets.YC_OAUTH_TOKEN }} # OAuth токен для Yandex Cloud
      YC_CONTAINER_REGISTRY_ID: ${{ secrets.YC_CONTAINER_REGISTRY_ID }} # ID реестра контейнеров в Yandex Cloud

    tasks:
      # Задача сборки Docker-образа
      - name: "build-test-docker"
        cubes:
          # Cube для сборки и отправки Docker-образа в реестр
          - name: "build-and-push-image"
            image: docker.io/library/docker:latest
            script:
              # Авторизация в Docker Hub
              - |
                echo "Авторизация в Docker Hub"
                echo "$DOCKER_PASSWORD" | \
                docker login -u "$DOCKER_USERNAME" --password-stdin

              # Авторизация в Yandex Cloud Container Registry
              - |
                echo "Авторизация в Yandex Cloud Container Registry"
                echo "$YC_OAUTH_TOKEN" | \
                docker login --username oauth --password-stdin cr.yandex

              # Сборка Docker-образа с использованием Dockerfile из директории personal_website
              - |
                echo "Сборка Docker-образа приложения"
                docker build \
                  -t $DOCKER_USERNAME/$PROJECT_NAME:$TEST_TAG \
                  -f personal_website/Dockerfile .

              # Тегирование образа для Yandex Cloud Container Registry
              - |
                echo "Тегирование Docker-образа для Yandex Cloud Container Registry"
                docker tag \
                  $DOCKER_USERNAME/$PROJECT_NAME:$TEST_TAG \
                  cr.yandex/$YC_CONTAINER_REGISTRY_ID/$PROJECT_NAME:$TEST_TAG

              # Отправка собранного образа в Docker Hub
              - |
                echo "Отправка Docker-образа в Docker Hub"
                docker push \
                  $DOCKER_USERNAME/$PROJECT_NAME:$TEST_TAG

              # Отправка собранного образа в Yandex Cloud Container Registry
              - |
                echo "Отправка Docker-образа в Yandex Cloud Container Registry"
                docker push \
                  cr.yandex/$YC_CONTAINER_REGISTRY_ID/$PROJECT_NAME:$TEST_TAG

          # Cube для запуска тестов внутри Docker-контейнера
          - name: "run-tests-in-container"
            image: docker.io/library/docker:latest
            script:
              # Авторизация в Docker Hub
              - |
                echo "Авторизация в Docker Hub"
                echo "$DOCKER_PASSWORD" | \
                docker login -u "$DOCKER_USERNAME" --password-stdin

              # Авторизация в Yandex Cloud Container Registry
              - |
                echo "Авторизация в Yandex Cloud Container Registry"
                echo "$YC_OAUTH_TOKEN" | \
                docker login --username oauth --password-stdin cr.yandex

              # Получение тестового образа из реестра (Yandex Cloud как основной)
              - |
                echo "Получение тестового Docker-образа из Yandex Cloud Container Registry"
                docker pull \
                  cr.yandex/$YC_CONTAINER_REGISTRY_ID/$PROJECT_NAME:$TEST_TAG

              # Запуск тестов внутри контейнера (на образе из Yandex Cloud)
              - |
                echo "Запуск тестов внутри Docker-контейнера"
                docker run --rm \
                  --env SOURCECRAFT_CI="$SOURCECRAFT_CI" \
                  --env SECRET_KEY="$SECRET_KEY" \
                  --env DEBUG="True" \
                  --entrypoint "" \
                  cr.yandex/$YC_CONTAINER_REGISTRY_ID/$PROJECT_NAME:$TEST_TAG \
                  bash -c "poetry run pytest"

              # Присвоение тега "tested" образу после успешного прохождения тестов (Docker Hub)
              - |
                echo "Тегирование Docker-образа как 'tested' для Docker Hub"
                docker tag \
                  $DOCKER_USERNAME/$PROJECT_NAME:$TEST_TAG \
                  $DOCKER_USERNAME/$PROJECT_NAME:$TESTED_TAG

              # Присвоение тега "tested" образу после успешного прохождения тестов (Yandex Cloud)
              - |
                echo "Тегирование Docker-образа как 'tested' для Yandex Cloud"
                docker tag \
                  cr.yandex/$YC_CONTAINER_REGISTRY_ID/$PROJECT_NAME:$TEST_TAG \
                  cr.yandex/$YC_CONTAINER_REGISTRY_ID/$PROJECT_NAME:$TESTED_TAG

              # Отправка протестированного образа в реестр (Docker Hub)
              - |
                echo "Отправка протестированного Docker-образа в Docker Hub"
                docker push \
                  $DOCKER_USERNAME/$PROJECT_NAME:$TESTED_TAG

              # Отправка протестированного образа в реестр (Yandex Cloud)
              - |
                echo "Отправка протестированного Docker-образа в Yandex Cloud Container Registry"
                docker push \
                  cr.yandex/$YC_CONTAINER_REGISTRY_ID/$PROJECT_NAME:$TESTED_TAG

  # Релиз Docker-образа с тэгом latest
  release-workflow:
    # Переменные окружения для процесса релиза Docker-образа
    env:
      PROJECT_NAME: "personal_website" # Имя проекта
      TESTED_TAG: "tested" # Тег для протестированного образа
      LATEST_TAG: "latest" # Тег для релизного образа
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }} # Имя пользователя Docker Hub
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }} # Пароль пользователя Docker Hub
      YC_OAUTH_TOKEN: ${{ secrets.YC_OAUTH_TOKEN }} # OAuth токен для Yandex Cloud
      YC_CONTAINER_REGISTRY_ID: ${{ secrets.YC_CONTAINER_REGISTRY_ID }} # ID реестра контейнеров в Yandex Cloud

    tasks:
      # Задача релиза Docker-образа
      - name: "release-docker"
        cubes:
          # Cube для перетегирования и отправки Docker-образа в реестры
          - name: "retag-and-push-image"
            image: docker.io/library/docker:latest
            script:
              # Авторизация в Docker Hub
              - |
                echo "Авторизация в Docker Hub"
                echo "$DOCKER_PASSWORD" | \
                docker login -u "$DOCKER_USERNAME" --password-stdin

              # Авторизация в Yandex Cloud Container Registry
              - |
                echo "Авторизация в Yandex Cloud Container Registry"
                echo "$YC_OAUTH_TOKEN" | \
                docker login --username oauth --password-stdin cr.yandex

              # Получение протестированного образа из Yandex Cloud Container Registry
              - |
                echo "Получение протестированного Docker-образа из Yandex Cloud Container Registry"
                docker pull \
                  cr.yandex/$YC_CONTAINER_REGISTRY_ID/$PROJECT_NAME:$TESTED_TAG

              # Перетегирование протестированного образа как "latest" для Docker Hub
              - |
                echo "Перетегирование Docker-образа как 'latest' для Docker Hub"
                docker tag \
                  $DOCKER_USERNAME/$PROJECT_NAME:$TESTED_TAG \
                  $DOCKER_USERNAME/$PROJECT_NAME:$LATEST_TAG

              # Перетегирование протестированного образа как "latest" для Yandex Cloud
              - |
                echo "Перетегирование Docker-образа как 'latest' для Yandex Cloud"
                docker tag \
                  cr.yandex/$YC_CONTAINER_REGISTRY_ID/$PROJECT_NAME:$TESTED_TAG \
                  cr.yandex/$YC_CONTAINER_REGISTRY_ID/$PROJECT_NAME:$LATEST_TAG

              # Отправка релизного образа в Docker Hub
              - |
                echo "Отправка релизного Docker-образа в Docker Hub"
                docker push \
                  $DOCKER_USERNAME/$PROJECT_NAME:$LATEST_TAG

              # Отправка релизного образа в Yandex Cloud Container Registry
              - |
                echo "Отправка релизного Docker-образа в Yandex Cloud Container Registry"
                docker push \
                  cr.yandex/$YC_CONTAINER_REGISTRY_ID/$PROJECT_NAME:$LATEST_TAG

              # Удаление старого тега из Docker Hub и Yandex Cloud Container Registry
              - |
                echo "Удаление старого тега 'tested' из Docker Hub"
                docker rmi \
                  $DOCKER_USERNAME/$PROJECT_NAME:$TESTED_TAG

              - |
                echo "Удаление старого тега 'tested' из Yandex Cloud Container Registry"
                docker rmi \
                  cr.yandex/$YC_CONTAINER_REGISTRY_ID/$PROJECT_NAME:$TESTED_TAG

  # Делой на VPS по SSH
  deploy-workflow:
    tasks:
      - name: "deploy-application"
        cubes:
          # Выполнение удаленного скрипта деплоя на сервере через SSH
          - name: execute-remote-deployment
            action: appleboy/ssh-action@v1.2.3
            with:
              host: ${{ secrets.SERVER_HOST }}
              username: ${{ secrets.SERVER_USER }}
              key: ${{ secrets.DEPLOY_SSH_KEY }}
              script: |
                cd /root/personal-website
                bash personal_website/scripts/server/update.sh
