# Конфигурация CI/CD для SourceCraft
# Функционально повторяет имеющиеся GitHub Workflow с учетом ограничения не более 3 тасок на 1 рабочий процесс

# Определение событий-триггеров для запуска рабочих процессов.
on:
  push:
    # Запускаются при пуше в любую ветку, кроме основной
    - workflows: [lint-workflow, test-workflow, build-workflow]
      filter:
        branches: ["!main", "!master"]

    # Запускается при пуше в основную ветку
    - workflows: [release-workflow]
      filter:
        branches: ["main", "master"]

# Определение рабочих процессов
workflows:
  # Статический анализ и линтинг
  lint-workflow:
    tasks:
      # Выполнить проверки утилитами Python
      - name: "python-check"
        cubes:
          - name: "ruff-mypy"
            image: docker.io/library/python:3.13-bookworm
            script:
              - pip install poetry
              - poetry install
              - poetry run ruff check
              - poetry run mypy .

      # Выполнить проверки утилитами Node.js
      - name: "node-check"
        cubes:
          - name: "eslint-markdown"
            image: docker.io/library/node
            script:
              - npm install
              - npx eslint . --ext .js,.jsx,.ts,.tsx
              - npx markdownlint-cli *.md docs/*.md

  # Тестирование
  test-workflow:
    # Определение переменных окружения для всего рабочего процесса
    env:
      DEBUG: "True"
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      PROJECT_NAME: "personal_website"
    tasks:
      # Тестирование кода Python
      - name: "python-test"
        cubes:
          - name: "pytest"
            image: docker.io/library/python:3.13-bookworm
            script:
              - apt-get update
              - apt-get install -y wkhtmltopdf locales
              - localedef -i ru_RU -c -f UTF-8 -A /usr/share/locale/locale.alias ru_RU.UTF-8
              - pip install poetry
              - poetry install
              - poetry run pytest

      # Тестирование кода JavaScript
      - name: "node-test"
        cubes:
          - name: "node"
            image: docker.io/library/node
            script:
              - npm install
              - npm test

  # Сборка и тестирование образа приложения
  build-workflow:
    # Переменные окружения для процесса сборки Docker-образа
    env:
      PROJECT_NAME: "personal_website" # Имя проекта
      SECRET_KEY: ${{ secrets.SECRET_KEY }} # Секретный ключ для Django
      TEST_TAG: "test" # Тег для тестового образа
      TESTED_TAG: "tested" # Тег для протестированного образа
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }} # Имя пользователя Docker Hub
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }} # Пароль пользователя Docker Hub
      SOURCECRAFT_TOKEN: ${{ secrets.SOURCECRAFT_TOKEN }} # Токен для SourceCraft Registry
      SOURCECRAFT_ORGANIZATION: ${{ secrets.SOURCECRAFT_ORGANIZATION }} # Имя организации в SourceCraft
      SOURCECRAFT_DOCKER_REGISTRY_ID: ${{ secrets.SOURCECRAFT_DOCKER_REGISTRY_ID }} # ID реестра Docker в SourceCraft

    tasks:
      # Задача сборки Docker-образа
      - name: "build-test-docker"
        cubes:
          # Cube для сборки и отправки Docker-образа в реестр
          - name: "build-and-push-image"
            image: docker.io/library/docker:latest
            script:
              # Авторизация в Docker Hub
              - |
                echo "$DOCKER_PASSWORD" | \
                docker login -u "$DOCKER_USERNAME" --password-stdin

              # Авторизация в SourceCraft Registry
              - |
                echo "$SOURCECRAFT_TOKEN" | \
                docker login --username iam --password-stdin pkg.sourcecraft.tech

              # Сборка Docker-образа с использованием Dockerfile из директории personal_website
              - |
                docker build \
                  -t $DOCKER_USERNAME/$PROJECT_NAME:$TEST_TAG \
                  -f personal_website/Dockerfile .

              # Тегирование образа для SourceCraft Registry
              - |
                docker tag \
                  $DOCKER_USERNAME/$PROJECT_NAME:$TEST_TAG \
                  pkg.sourcecraft.tech/cr/$SOURCECRAFT_ORGANIZATION/$SOURCECRAFT_DOCKER_REGISTRY_ID/$PROJECT_NAME:$TEST_TAG

              # Отправка собранного образа в Docker Hub
              - |
                docker push \
                  $DOCKER_USERNAME/$PROJECT_NAME:$TEST_TAG

              # Отправка собранного образа в SourceCraft Registry
              - |
                docker push \
                  pkg.sourcecraft.tech/cr/$SOURCECRAFT_ORGANIZATION/$SOURCECRAFT_DOCKER_REGISTRY_ID/$PROJECT_NAME:$TEST_TAG

          # Cube для запуска тестов внутри Docker-контейнера
          - name: "run-tests-in-container"
            image: docker.io/library/docker:latest
            script:
              # Авторизация в Docker Hub
              - |
                echo "$DOCKER_PASSWORD" | \
                docker login -u "$DOCKER_USERNAME" --password-stdin

              # Авторизация в SourceCraft Registry
              - |
                echo "$SOURCECRAFT_TOKEN" | \
                docker login --username iam --password-stdin pkg.sourcecraft.tech

              # Получение тестового образа из реестра (SourceCraft как основной)
              - |
                docker pull \
                  pkg.sourcecraft.tech/cr/$SOURCECRAFT_ORGANIZATION/$SOURCECRAFT_DOCKER_REGISTRY_ID/$PROJECT_NAME:$TEST_TAG

              # Запуск тестов внутри контейнера (на образе из SourceCraft)
              - |
                docker run --rm \
                  --env SOURCECRAFT_CI="$SOURCECRAFT_CI" \
                  --env SECRET_KEY="$SECRET_KEY" \
                  --env DEBUG="True" \
                  --entrypoint "" \
                  pkg.sourcecraft.tech/cr/$SOURCECRAFT_ORGANIZATION/$SOURCECRAFT_DOCKER_REGISTRY_ID/$PROJECT_NAME:$TEST_TAG \
                  bash -c "poetry run pytest"

              # Присвоение тега "tested" образу после успешного прохождения тестов (Docker Hub)
              - |
                docker tag \
                  $DOCKER_USERNAME/$PROJECT_NAME:$TEST_TAG \
                  $DOCKER_USERNAME/$PROJECT_NAME:$TESTED_TAG

              # Присвоение тега "tested" образу после успешного прохождения тестов (SourceCraft)
              - |
                docker tag \
                  pkg.sourcecraft.tech/cr/$SOURCECRAFT_ORGANIZATION/$SOURCECRAFT_DOCKER_REGISTRY_ID/$PROJECT_NAME:$TEST_TAG \
                  pkg.sourcecraft.tech/cr/$SOURCECRAFT_ORGANIZATION/$SOURCECRAFT_DOCKER_REGISTRY_ID/$PROJECT_NAME:$TESTED_TAG

              # Отправка протестированного образа в реестр (Docker Hub)
              - |
                docker push \
                  $DOCKER_USERNAME/$PROJECT_NAME:$TESTED_TAG

              # Отправка протестированного образа в реестр (SourceCraft)
              - |
                docker push \
                  pkg.sourcecraft.tech/cr/$SOURCECRAFT_ORGANIZATION/$SOURCECRAFT_DOCKER_REGISTRY_ID/$PROJECT_NAME:$TESTED_TAG

  # release-workflow - запускается при пуше в ветку main
  release-workflow:
    tasks:
      - name: "create-release"
        cubes:
          - name: "echo-release-message"
            script:
              - "echo 'Creating release...'"

  # Запускается вручную
  deploy-workflow:
    tasks:
      - name: "deploy-application"
        cubes:
          - name: "echo-deploy-message"
            script:
              - "echo 'Deploying application...'"
