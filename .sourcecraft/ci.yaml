# Конфигурация CI/CD для SourceCraft
# Документация: https://sourcecraft.dev/portal/docs/ru/sourcecraft/operations/ci-cd

# Настройка событий-триггеров
on:
  # Запуск тестов при создании или обновлении pull request
  pull_request:
    - workflows: [test-workflow]

  # Запуск релиза при пуше в ветку main
  push:
    - workflows: [release-workflow]
      filter:
        branches: ["main"]

# Определение рабочих процессов
workflows:
  # Рабочий процесс для тестирования
  test-workflow:
    env:
      DEBUG: true
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      PROJECT_NAME: personal_website
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_HOST: localhost
      POSTGRES_PORT: 5432
      POSTGRES_DB: personal_website
      EMAIL_HOST_USER: ${{ secrets.EMAIL_HOST_USER }}
      EMAIL_HOST_PASSWORD: ${{ secrets.EMAIL_HOST_PASSWORD }}
      DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
      LANG: ru_RU.utf8
      PYTHON_VERSION: "3.12"
      NODE_VERSION: "latest"
      TEST_TAG: test
      TESTED_TAG: tested
      TEST_IMAGE_NAME: ghcr.io/${{ repository }}:${TEST_TAG}
      TESTED_IMAGE_NAME: ghcr.io/${{ repository }}:${TESTED_TAG}
    tasks:
      - name: cache-dependencies-task
        cubes:
          - name: cache-poetry
            image: docker.io/library/python:3.12
            script:
              - python -m pip install --upgrade pip
              - pip install poetry
              - poetry install
            env:
              POETRY_CACHE_KEY: poetry-${{ hashFiles('**/poetry.lock') }}

          - name: cache-npm
            image: docker.io/library/node:latest
            script:
              - npm install
            env:
              NPM_CACHE_KEY: npm-${{ hashFiles('**/package-lock.json') }}

      - name: lint-task
        needs: [cache-dependencies-task]
        cubes:
          - name: ruff-check
            image: docker.io/library/python:3.12
            script:
              - python -m pip install --upgrade pip
              - pip install poetry
              - poetry install
              - poetry run ruff check

          - name: mypy-check
            image: docker.io/library/python:3.12
            script:
              - python -m pip install --upgrade pip
              - pip install poetry
              - poetry install
              - poetry run mypy .

          - name: eslint-check
            image: docker.io/library/node:latest
            script:
              - npm install
              - npx eslint . --ext .js,.jsx,.ts,.tsx

          - name: markdownlint-check
            image: docker.io/library/node:latest
            script:
              - npm install
              - npx markdownlint-cli *.md docs/*.md

      - name: test-task
        needs: [cache-dependencies-task]
        cubes:
          - name: run-tests
            image: docker.io/library/python:3.12
            script:
              - apt-get update && apt-get install -y wkhtmltopdf locales
              - localedef -i ru_RU -c -f UTF-8 -A /usr/share/locale/locale.alias ru_RU.UTF-8
              - python -m pip install --upgrade pip
              - pip install poetry
              - poetry install
              - npm install
              - poetry run python personal_website/manage.py makemigrations --dry-run --check
              - poetry run python personal_website/manage.py collectstatic --noinput
              - poetry run pytest
            artifacts:
              paths:
                - htmlcov/
                - coverage.xml

      - name: build-image-task
        needs: [test-task]
        cubes:
          - name: build-and-push-test-image
            image: docker.io/library/docker:latest
            script:
              - docker build -t $TEST_IMAGE_NAME -f personal_website/Dockerfile .
              - docker login ghcr.io -u ${{ secrets.GITHUB_ACTOR }} -p ${{ secrets.GITHUB_TOKEN }}
              - docker push $TEST_IMAGE_NAME

      - name: test-container-task
        needs: [build-image-task]
        cubes:
          - name: test-in-container
            image: docker.io/library/docker:latest
            script:
              - docker login ghcr.io -u ${{ secrets.GITHUB_ACTOR }} -p ${{ secrets.GITHUB_TOKEN }}
              - docker pull $TEST_IMAGE_NAME
              - docker tag $TEST_IMAGE_NAME $TESTED_IMAGE_NAME
              - docker push $TESTED_IMAGE_NAME

  # Рабочий процесс для релиза
  release-workflow:
    env:
      TESTED_TAG: tested
      LATEST_TAG: latest
      TESTED_IMAGE_NAME: ghcr.io/${{ repository }}:${TESTED_TAG}
      GITHUB_RELEASE_IMAGE_NAME: ghcr.io/${{ repository }}:${LATEST_TAG}
      DOCKER_RELEASE_IMAGE_NAME: ${{ repository }}:${LATEST_TAG}
    tasks:
      - name: retag-and-push-task
        cubes:
          - name: retag-and-push
            image: docker.io/library/docker:latest
            script:
              - docker login ghcr.io -u ${{ secrets.GITHUB_ACTOR }} -p ${{ secrets.GITHUB_TOKEN }}
              - docker pull $TESTED_IMAGE_NAME
              - docker tag $TESTED_IMAGE_NAME $GITHUB_RELEASE_IMAGE_NAME
              - docker push $GITHUB_RELEASE_IMAGE_NAME
              - docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
              - docker tag $TESTED_IMAGE_NAME $DOCKER_RELEASE_IMAGE_NAME
              - docker push $DOCKER_RELEASE_IMAGE_NAME

  # Рабочий процесс для деплоя
  deploy-workflow:
    env:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
    tasks:
      - name: deploy-task
        needs: [release-workflow]
        cubes:
          - name: deploy-to-vps
            image: docker.io/library/alpine:latest
            script:
              - apk add --no-cache openssh-client
              - mkdir -p ~/.ssh
              - echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_rsa
              - chmod 600 ~/.ssh/id_rsa
              - ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
              - ssh -i ~/.ssh/id_rsa $SERVER_USER@$SERVER_HOST "cd /root/personal-website && bash personal_website/scripts/server/update.sh"
            env:
              DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
