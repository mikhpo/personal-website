# Персональный сайт

<div align="center">
    <img src="../static/android-chrome-192x192.png" width="10%" style="border:10px;margin:10px"></img>
</div>
<div align="center">
    <img src="./logos/Python-logo-notext.svg" width="10%" style="border:10px;margin:10px"></img>
    <img src="./logos/Postgresql_elephant.svg" width="10%" style="border:10px;margin:10px"></img>
    <img src="./logos/Bootstrap_logo.svg" width="10%" style="border:10px;margin:10px"></img>
</div>
<div align="center">
    <img src="./logos/Django_logo.svg" width="20%" style="border:10px;margin:10px"></img>
</div>
<div align="center">
    <img src="./logos/Gunicorn_logo_2010.svg" width="20%" style="border:10px;margin:10px"></img>
    <img src="./logos/Nginx_logo.svg" width="20%" style="border:10px;margin:10px"></img>
    <img src="./logos/Logo-ubuntu_no(r)-black_orange-hex.svg" width="20%" style="border:10px;margin:10px"></img>
</div>

Проект по созданию персонального сайта. Конфигурация, функции, классы и шаблоны максимально абстрактными - так, чтобы можно было использовать проект в качестве шаблона для другого сайта.

## Функциональность сайта

Для сайта созданы следующий функционал:

* Блог: статьи и комментарии.
* Скрипты: ручной и автоматический запуск, просмотр логов.
* Пользователи: регистрация и авторизация.
* Администрирование: CRUD, настройка ролей.

## Технологический стек

Проект использует следующие технологии:

* [Django](https://www.djangoproject.com/) (бэкенд)
* [Bootstrap](https://getbootstrap.com/) (фронтенд)
* [PostgreSQL](https://www.postgresql.org/) (база данных)

Проект адаптрован для развертывания на Linux. Для развертывания на Linux используются следующие технологии:

* [Gunicorn](https://gunicorn.org/) (HTTP сервер)
* [Nginx](https://nginx.org/) (прокси-сервер)

## Управление зависимостями Python

Для управления зависимостями в проекте используется [Poetry](https://python-poetry.org/).

Файлы Poetry:

* `pyproject.toml` - описание проекта и список основных зависимостей.
* `poetry.toml` - конфигурация использования Poetry в проекте.
* `poetry.lock` - расширенный список зависимостей.

Зависимости также зафиксированы в `requirements.txt`.

Для установки зависимостей необходимо использовать команду:

    poetry install

Poetry сконфигурирован таким образом, чтобы виртуальное окружение создавалось в каталоге проекта. Если витуальное окружение ещё не создано, то после команды `poetry install` оно будет создано автоматически в папке `.venv`.

Для запуска сервера разработки можно применить команду:

    poetry run python manage.py runserver

Предварительно активировать виртуальное окружение при этом не нужно. Однако можно запустить сервер разработки и традиционным способом - через предварительную активацию виртуального окружения:

    .venv/scripts/activate
    python manage.py runserver

## Структура проекта

Проект использует нестандартную номенклатуру каталогов.

Типичная структура каталогов, созданная при помощи команды `django-admin startproject mysite`, будет выглядеть следующим образом:

    project/
        .git/
        .venv/
        .gitignore
        requirements.txt
        mysite/ <-- корневой каталог исходного кода
            manage.py
            mysite/ <-- каталог с настройками проекта и главным маршрутизатором
                __init__.py
                settings.py
                urls.py
                asgi.py
                wsgi.py
            app1
            app2

В данном проекте структура каталогов была изменена следующим образом для повышения универсальности:

    project/
        .git/
        .venv/
        .gitignore
        requirements.txt
        manage.py
        config/ <-- каталог с настройками проекта и главным маршрутизатором
            __init__.py
            settings.py
            urls.py
            asgi.py
            wsgi.py
        apps/
            app1/
            app2/

## Административные команды

Для запуска веб-сервера Django используется команда:

    python manage.py runserver

После внесения изменений в модели необходимо произвести миграцию таблиц базы данных. Django имеет встроенный инструмент управления миграциями. Для проведения миграций используются команды:

    python manage.py makemigrations
    python manage.py migrate

В данном проекте созданы пользовательские административные команды, которые используются для выполнения обособленных скриптов. Вызываются аналогичным образом:

    python manage.py <имя команды>

## Исключения из репозитория

Из проекта исключены следующие файлы и папки:

* Виртуальное окружение
* Настройки Visual Studio Code
* Файл с секретными данными (логины, пароли, адреса)
* Сертификат
* RSA ключ
* Node.js (npm) зависимости
* Логи
* Файлы кэша

## Управление статическими файлами

Статические файлы - это CSS-библиотеки, JavaScript-модули, фавиконы и др. Все статические файлы собраны в каталоге `static`.

### Набор статических файлов

* `package.json` - описание основных Node.js зависимостей, обновляется автоматически через команды npm.
* `package-lock.json` - автообновляемый отчет, в котором фиксируется полный список npm-зависимостей и источников установки.
* `node_modules` - Node.js модули.
* `robots.txt` - файл управления допусками поисковых систем.
* `favicon.ico` - основной фавикон сайта. Также каталог содержит версии этого же фавикона в других размерах и расширениях под различные виды устройств.
* `staticfiles.json` - созданный библиотекой WhiteNoise манифест, в котором прописаны пути до всех статических файлов.
* `admin` - статические файлы административного интерфейса Django (CSS, JS, шрифты).
* `tinymce` - статические файлы WYSIWYG-редактора TinyMCE.
* `django_tinymce` - сторонний модуль, упрощающий интеграцию TinyMCE с Django.

### Установка статических файлов

Для установки Node.js зависимостей необходимо воспользоваться командой:

    npm install

Часть CSS и JS модулей, используемых пакетами Django, необходимо установить командой:

    python manage.py collectstatic

## Приложения проекта

### Контроль учетных записей

Приложение управляет процессом создания учетных записей. Базовая модель аутентификации пользователей Django слишком слабая для серьезного использования. Данное приложение не создает альтернативную модель пользователя, но накладывает дополнительные ограничения, расширяя функционал формы регистрации:

1. Обязательно указание адреса электронной почты.
2. Адрес электронной почты должен быть уникальным.
3. Имя и фамилия не должны совпадать.

### Блог

Одно из ключевых приложений сайта - управлене блогом и комментариями к записям в нем.

В рамках блога используются следующие модели:

1. Статья - как единичная запись в блоге, ключевая модель приложения.
2. Комментарий - пользователи могут оставлять к статьям комментарии.
3. Серия - статьи могут объединяться в серии.
4. Тема - серии могут объединяться по темам.
5. Категория - темы могут объединяться по категориям.

Статьи можно создавать и редактировать через административный интерфейс. Тело статьи редактируется при помощи WYSIWYG-виджета TinyMCE. Статью можно создать, но не опубликовать  для этого есть специальный флаг. Точно так же можно уже опубликованную статью снять с публикации, не удаляя материал.

### Скрипты

Приложение для управления скриптами. Скрипты добавляются в качестве административных команд Django. Для логирования статуса выполнения скриптов используется декоратор из модуля `decorators.py`, в котором прописана вся логика сохранения результатов в базе данных приложения.

#### Модель данных

Для управления задачами используется две модели:

1. Скрипт (Job) - название скрипта, описание и ссылка для запуска.
2. Выполнение (Execution) - обособленный процесс выполнения скрипта.

Иными словами, скрипт - это задача, её описание и способ запуска. Выполнение - это хранение информации о состоянии выполнения задачи. У одного скрипта может быть много запусков, но один запуск может быть связан только с одним скриптом. Это взаимсовязь определена через `ForeignKey`.

#### Запуск скриптов

Запустить скрипт можно несколькими способами:

1. Вручную:
    * Через браузер, перейдя по ссылке `https://<domain_name>/scripts/<slug>`.
    * CLI-командой `python manage.py <slug>` (используя виртуальное окружение проекта) - через терминал сервера.
    * CLI-командой `curl https://<domain_name>/scripts/<slug>` - через терминал иных устройств.
    * Из программного кода, используя функцию `management.call_command('<slug>')`.

2. Автоматически:
    * Используя crontab для вызова каждой команды:
        * либо `curl https://<domain_name>/scripts/<slug>`,
        * либо `python manage.py <slug>`.

* **Через браузер** - при создании объекта "Скрипт" заполняется поле `SlugField`, который используется для создания абсолютного URL, по которому вызывается запуск скрипта. Допустим, у скрипта имеется определенный `slug`. Тогда абсолютный путь для запуска данного скрипта будет выглядеть следующим образом: `https://<domain_name>/scripts/<slug>`.

При использовании данного URL происходит вызов скрипта -> в отдельном процессе вызывается административная команда Django, название которой соответствует слагу: например, `python manage.py <slug>`. Таким образом, процесс получает доступ к контексту Django и записывает состояние выполнения скрипта в базу данных, управляемую Django. Для того, чтобы выполнение скрипта не оказывало влияние на основной процесс Django, административная команда вызывается через `suprocess.Popen`:

    suprocess.Popen(["python", "manage.py", "<slug>"])

* **Через терминал сервера** - команду `python manage.py <slug>` можно ввести вручную в терминале сервера. Этот метод удобно применять в том случае, если на сервере настроен планировщик задач (cron, Windows Task Scheduler или альтернатива). При этом необходимо предварительно указать путь до интерпретатора Python из виртуального окружения. Это можно сделать несколькими способами:

1. Предварительно активировав виртуальное окружение.

        cd project_folder
        .venv/scripts/activate
        python manage.py <slug>

2. Вызвав скрипт через Poetry.

        cd project_folder
        poetry run python manage.py <slug>

* **Через терминал клиентского ПК** - можно вызвать выполнение скрипта через curl: `curl https://<domain_name>/scripts/<slug>`. Это удобно в том случае, если планировщик задач настроен на клиентском ПК.

* **Вызов команды напрямую из программного кода** - скрипт, как и любую административную команду Django, можно вызвать в программном коде через фукнцию `management.call_command('<slug>')`. При этом команда будет выполняться в синхронном режиме - т.е. выполнение основного процесса будет приостановлено до тех пор, пока не будет выполнен скрипт. Этот метод уместно использовать только в тех случаях, когда время выполнения скрипта занимает не более нескольких секунд.

Дополнительная информация по административным командам Django и библиотеке APScheduler:

* [django-admin and manage.py](https://docs.djangoproject.com/en/dev/ref/django-admin/)
* [How to create custom django-admin commands](https://docs.djangoproject.com/en/dev/howto/custom-management-commands/)
* [Advanced Python Scheduler](https://apscheduler.readthedocs.io/en/latest/)
