# Персональный сайт

<div align="center">
    <img src="../personal_website/static/android-chrome-192x192.png" width="10%" style="border:10px;margin:10px"></img>
</div>
<div align="center">
    <img src="./logos/Django_logo.svg" width="20%" style="border:10px;margin:10px"></img>
</div>
<div align="center">
    <img src="./logos/Python-logo-notext.svg" width="10%" style="border:10px;margin:10px"></img>
    <img src="./logos/Bootstrap_logo.svg" width="12%" style="border:10px;margin:10px"></img>  
    <img src="./logos/Postgresql_elephant.svg" width="10%" style="border:10px;margin:10px"></img>
</div>
<div align="center">
    <img src="./logos/Gunicorn_logo_2010.svg" width="20%" style="border:10px;margin:15px"></img>
    <img src="./logos/Nginx_logo.svg" width="20%" style="border:10px;margin:15px"></img>
    <img src="./logos/Logo-ubuntu_no(r)-black_orange-hex.svg" width="20%" style="border:10px;margin:15px"></img>
</div>

Проект по созданию персонального сайта. Конфигурация, функции, классы и шаблоны максимально абстрактными - так, чтобы можно было использовать проект в качестве шаблона для другого сайта.

## Функциональность сайта

Для сайта созданы следующий функционал:

* Блог: статьи и комментарии.
* Скрипты: ручной и автоматический запуск, просмотр логов.
* Пользователи: регистрация и авторизация.
* Администрирование: CRUD, настройка ролей.

## Технологический стек

Проект использует следующие технологии:

* [Django](https://www.djangoproject.com/) (бэкенд)
* [Bootstrap](https://getbootstrap.com/) (фронтенд)
* [PostgreSQL](https://www.postgresql.org/) (база данных)

Проект адаптрован для развертывания на Linux. Для развертывания на Linux используются следующие технологии:

* [Gunicorn](https://gunicorn.org/) (HTTP-сервер)
* [Nginx](https://nginx.org/) (прокси-сервер)

## Управление зависимостями Python

Для управления зависимостями в проекте используется [Poetry](https://python-poetry.org/).

Файлы Poetry:

* `pyproject.toml` - описание проекта и список основных зависимостей.
* `poetry.toml` - конфигурация использования Poetry в проекте.
* `poetry.lock` - расширенный список зависимостей.

Зависимости также зафиксированы в `requirements.txt`.

Для установки зависимостей необходимо использовать команду:

    poetry install

Для обновления зависимостей можно воспользоваться пакетом `poetryup`. Его необходимо установить в виртуальное окружение проекта как dev-зависимость при помощи команды `poetry add poetryup --dev`. Запустить обновление зависимостей проекта можно следующей командой:

    poetry run poetryup

Отличие этой команды от команды `poetry update` заключается в том, что она также приводит к обновлению версий пакетов файле `pyproject.toml`.

Poetry сконфигурирован таким образом, чтобы виртуальное окружение создавалось в каталоге проекта. Если витуальное окружение ещё не создано, то после команды `poetry install` оно будет создано автоматически в папке `.venv`.

Для фиксации зависимостей в файле `requirements.txt` необходимо воспользоваться следующей командой:

    poetry export -f requirements.txt --output requirements.txt --without-hashes --with dev

## Секреты и переменные окружения

Для управления переменными окружения и секретами используется модуль [django-environ](https://django-environ.readthedocs.io/en/latest/index.html). Переменные окружения считываются из файла `.env`, который расположен в той же директории, что и `manage.py`. Данный файл исключен из Git-репозитория, но список используемых переменных окружения зафиксирован также в файле `.env.dist`, который актуализируется вместе с `.env`.

## Запуск сервера

Для запуска сервера разработки можно применить команду:

    poetry run python personal_website/manage.py runserver

Предварительно активировать виртуальное окружение при этом не нужно. Однако можно запустить сервер разработки и традиционным способом - через предварительную активацию виртуального окружения:

    .venv/scripts/activate
    python personal_website/manage.py runserver

Также можно воспользоваться bash командой:

    sh ./scripts/run_server.sh

## Структура проекта

Проект использует нестандартную номенклатуру каталогов.

Типичная структура каталогов, созданная при помощи команды `django-admin startproject personal_website`, будет выглядеть следующим образом:

    personal-website/ <-- корневая директория репозитория
        .git/
        .venv/
        .gitignore
        requirements.txt
        personal_website/ <-- базовая директория проекта Django
            manage.py
            personal_website/ <-- директория с настройками проекта
                __init__.py
                settings.py
                urls.py
                asgi.py
                wsgi.py
            app1/
            app2/

## Административные команды

Для запуска веб-сервера Django используется команда:

    python personal_website/manage.py runserver

После внесения изменений в модели необходимо произвести миграцию таблиц базы данных. Django имеет встроенный инструмент управления миграциями. Для проведения миграций используются команды:

    python personal_website/manage.py makemigrations
    python personal_website/manage.py migrate

В данном проекте созданы пользовательские административные команды, которые используются для выполнения обособленных скриптов. Вызываются аналогичным образом:

    python personal_website/manage.py <имя команды>

## Управление статическими файлами

Статические файлы - это CSS-библиотеки, JavaScript-модули, фавиконы и др. Все статические файлы собраны в каталоге `static`.

### Набор статических файлов

* `package.json` - описание основных Node.js зависимостей, обновляется автоматически через команды npm.
* `package-lock.json` - автообновляемый отчет, в котором фиксируется полный список npm-зависимостей и источников установки.
* `node_modules` - Node.js модули.
* `robots.txt` - файл управления допусками поисковых систем.
* `favicon.ico` - основной фавикон сайта. Также каталог содержит версии этого же фавикона в других размерах и расширениях под различные виды устройств.
* `staticfiles.json` - созданный библиотекой WhiteNoise манифест, в котором прописаны пути до всех статических файлов.
* `admin` - статические файлы административного интерфейса Django (CSS, JS, шрифты).
* `tinymce` - статические файлы WYSIWYG-редактора TinyMCE.
* `django_tinymce` - сторонний модуль, упрощающий интеграцию TinyMCE с Django.

### Установка статических файлов

Для установки Node.js зависимостей необходимо воспользоваться командой:

    npm install

Часть CSS и JS модулей, используемых пакетами Django, необходимо установить командой:

    python personal_website/manage.py collectstatic

## Приложения проекта

### Контроль учетных записей

Приложение управляет процессом создания учетных записей. Базовая модель аутентификации пользователей Django слишком слабая для серьезного использования. Данное приложение не создает альтернативную модель пользователя, но накладывает дополнительные ограничения, расширяя функционал формы регистрации:

1. Обязательно указание адреса электронной почты.
2. Адрес электронной почты должен быть уникальным.
3. Имя и фамилия не должны совпадать.

### Блог

Одно из ключевых приложений сайта - управлене блогом и комментариями к записям в нем.

В рамках блога используются следующие модели:

1. Статья - как единичная запись в блоге, ключевая модель приложения.
2. Комментарий - пользователи могут оставлять к статьям комментарии.
3. Серия - статьи могут объединяться в серии.
4. Тема - серии могут объединяться по темам.
5. Категория - темы могут объединяться по категориям.

Статьи можно создавать и редактировать через административный интерфейс. Тело статьи редактируется при помощи WYSIWYG-виджета TinyMCE. Статью можно создать, но не опубликовать - для этого есть специальный флаг. При помощи него же опубликованную статью можно снять с публикации.

## Вспомогательные скрипты

Вспомогательные скрипты расположены в директории `scripts` внутри корневой директории проекта. Предназначение данных скриптов - упрощение процесса разработки, развертывания и обслуживания проекта. Текущий набор вспомогательных скриптов включает в себя:

* `add_cron_jobs.sh` - добавить задачи в cron.
* `backup_database.py` - создать бэкап базы данных.
* `backup_storage.py` - создать бэкап загруженных файлов.
* `install_dependencies.sh` - установка зависимостей внутри проекта.
* `make_link.sh` - создать символическую ссылку на node_modules.
* `restart_services.sh` - перезапустить Gunicorn, Nginx и PostgreSQL.
* `restore_database.py` - восстановить базу данных из дампа.
* `run_server.sh` - запустить сервер в режиме разработки.
* `run_tests.sh` - провести тесты.
* `update_project.sh` - получить изменения и перезапустить сервер.

## Логирование

 В проекте используется стандартная библиотека логирования `logging`. Логи записываются в папку `logs` в корневой директории проекта с ежедневной ротацией файлов и хранением логов в течение недели.

## Тестирование

Проект использует несолько уровней тестирования:

* тестирование общих настроек проекта модулем `unittest` Python
* тестирование общих настроек проекта модулем `test` Node.js
* тестирование функциональности проекта Django модулем `django.test`

Для запуска общих тестов Python можно воспользоваться командой:

    poetry run python -m unittest

Для запуска общих тестов Node.js можно воспользоваться командой:

    npm test

Для запуска тестов Django можно воспользоваться командой:

    cd personal_website
    poetry run python manage.py test

Также для выполнения всех тестов можно запустить bash-скрипт `run_tests.sh`:

    bash ./scripts/run_tests.sh
