# Персональный сайт

<div align="center">
    <img src="../personal_website/static/android-chrome-192x192.png" width="10%" style="border:10px;margin:10px"></img>
</div>
<div align="center">
    <img src="./logos/Django_logo.svg" width="20%" style="border:10px;margin:10px"></img>
</div>
<div align="center">
    <img src="./logos/Python-logo-notext.svg" width="10%" style="border:10px;margin:10px"></img>
    <img src="./logos/Bootstrap_logo.svg" width="12%" style="border:10px;margin:10px"></img>  
    <img src="./logos/Postgresql_elephant.svg" width="10%" style="border:10px;margin:10px"></img>
</div>
<div align="center">
    <img src="./logos/Gunicorn_logo_2010.svg" width="20%" style="border:10px;margin:15px"></img>
    <img src="./logos/Nginx_logo.svg" width="20%" style="border:10px;margin:15px"></img>
    <img src="./logos/Logo-ubuntu_no(r)-black_orange-hex.svg" width="20%" style="border:10px;margin:15px"></img>
</div>

Проект по созданию персонального сайта. Конфигурация, функции, классы и шаблоны максимально абстрактными - так, чтобы можно было использовать проект в качестве шаблона для другого сайта.

## Функциональность сайта

Для сайта созданы следующий функционал:

* Блог: статьи и комментарии.
* Скрипты: ручной и автоматический запуск, просмотр логов.
* Пользователи: регистрация и авторизация.
* Администрирование: CRUD, настройка ролей.

## Технологический стек

Проект использует следующие технологии:

* [Django](https://www.djangoproject.com/) (бэкенд)
* [Bootstrap](https://getbootstrap.com/) (фронтенд)
* [PostgreSQL](https://www.postgresql.org/) (база данных)

Проект адаптрован для развертывания на Linux. Для развертывания на Linux используются следующие технологии:

* [Gunicorn](https://gunicorn.org/) (HTTP-сервер)
* [Nginx](https://nginx.org/) (прокси-сервер)

## Управление зависимостями Python

Для управления зависимостями в проекте используется [Poetry](https://python-poetry.org/).

Файлы Poetry:

* `pyproject.toml` - описание проекта и список основных зависимостей.
* `poetry.toml` - конфигурация использования Poetry в проекте.
* `poetry.lock` - расширенный список зависимостей.

Зависимости также зафиксированы в `requirements.txt`.

Для установки зависимостей необходимо использовать команду:

    poetry install

Для обновления зависимостей можно воспользоваться пакетом `poetry-plugin-up`. Его необходимо установить при помощи команды `poetry self add poetry-plugin-up`. Запустить обновление зависимостей проекта можно следующей командой:

    poetry up --latest

Отличие этой команды от команды `poetry update` заключается в том, что она также приводит к обновлению версий пакетов в файле `pyproject.toml`.

Poetry сконфигурирован таким образом, чтобы виртуальное окружение создавалось в каталоге проекта. Если витуальное окружение ещё не создано, то после команды `poetry install` оно будет создано автоматически в папке `.venv`.

Для фиксации зависимостей в файле `requirements.txt` необходимо воспользоваться следующей командой:

    poetry export -f requirements.txt --output requirements.txt --without-hashes --with dev

В случае обновления релиза Python для обновления виртуального окружения необходимо после установки новой версии Python в систему использовать команду `poetry env use` с указанием версии Python. Например, чтобы переключиться на Python 3.12:

    poetry env use 3.12

Для обновления релиза Poetry необходимо использовать команду:

    poetry self update

## Секреты и переменные окружения

Для управления переменными окружения и секретами используется модуль [django-environ](https://django-environ.readthedocs.io/en/latest/index.html). Переменные окружения считываются из файла `.env`, который расположен в той же директории, что и `manage.py`. Данный файл исключен из Git-репозитория, но список используемых переменных окружения зафиксирован также в файле `.env.dist`, который актуализируется вместе с `.env`.

## Запуск сервера

Для запуска сервера разработки можно применить команду:

    poetry run python personal_website/manage.py runserver

Предварительно активировать виртуальное окружение при этом не нужно. Однако можно запустить сервер разработки и традиционным способом - через предварительную активацию виртуального окружения:

    .venv/scripts/activate
    python personal_website/manage.py runserver

Также можно воспользоваться bash командой:

    sh ./scripts/run_server.sh

## Структура проекта

Проект использует нестандартную номенклатуру каталогов.

Типичная структура каталогов, созданная при помощи команды `django-admin startproject personal_website`, будет выглядеть следующим образом:

    personal-website/ <-- корневая директория репозитория
        .git/
        .venv/
        .gitignore
        requirements.txt
        personal_website/ <-- базовая директория проекта Django
            manage.py
            personal_website/ <-- директория с настройками проекта
                __init__.py
                settings.py
                urls.py
                asgi.py
                wsgi.py
            app1/
            app2/

## Административные команды

Для запуска веб-сервера Django используется команда:

    python personal_website/manage.py runserver

После внесения изменений в модели необходимо произвести миграцию таблиц базы данных. Django имеет встроенный инструмент управления миграциями. Для проведения миграций используются команды:

    python personal_website/manage.py makemigrations
    python personal_website/manage.py migrate

В данном проекте созданы пользовательские административные команды, которые используются для выполнения обособленных скриптов. Вызываются аналогичным образом:

    python personal_website/manage.py <имя команды>

## Управление статическими файлами

Статические файлы - это CSS-библиотеки, JavaScript-модули, фавиконы и др. Все статические файлы собраны в каталоге `static`.

### Набор статических файлов

* `package.json` - описание основных Node.js зависимостей, обновляется автоматически через команды npm.
* `package-lock.json` - автообновляемый отчет, в котором фиксируется полный список npm-зависимостей и источников установки.
* `node_modules` - Node.js модули.
* `robots.txt` - файл управления допусками поисковых систем.
* `favicon.ico` - основной фавикон сайта. Также каталог содержит версии этого же фавикона в других размерах и расширениях под различные виды устройств.
* `staticfiles.json` - созданный библиотекой WhiteNoise манифест, в котором прописаны пути до всех статических файлов.
* `admin` - статические файлы административного интерфейса Django (CSS, JS, шрифты).
* `tinymce` - статические файлы WYSIWYG-редактора TinyMCE.
* `django_tinymce` - сторонний модуль, упрощающий интеграцию TinyMCE с Django.

### Установка статических файлов

Для установки Node.js зависимостей необходимо воспользоваться командой:

    npm install

Часть CSS и JS модулей, используемых пакетами Django, необходимо установить командой:

    python personal_website/manage.py collectstatic

## Приложения проекта

### Контроль учетных записей

Приложение управляет процессом создания учетных записей. Базовая модель аутентификации пользователей Django слишком слабая для серьезного использования. Данное приложение не создает альтернативную модель пользователя, но накладывает дополнительные ограничения, расширяя функционал формы регистрации:

1. Обязательно указание адреса электронной почты.
2. Адрес электронной почты должен быть уникальным.
3. Имя и фамилия не должны совпадать.

### Блог

Одно из ключевых приложений сайта - управлене блогом и комментариями к записям в нем.

В рамках блога используются следующие модели:

1. Статья - как единичная запись в блоге, ключевая модель приложения.
2. Комментарий - пользователи могут оставлять к статьям комментарии.
3. Серия - статьи могут объединяться в серии.
4. Тема - серии могут объединяться по темам.
5. Категория - темы могут объединяться по категориям.

Статьи можно создавать и редактировать через административный интерфейс. Тело статьи редактируется при помощи WYSIWYG-виджета TinyMCE. Статью можно создать, но не опубликовать - для этого есть специальный флаг. При помощи него же опубликованную статью можно снять с публикации.

## Отдельные скрипты

Отдельные скрипты расположены в директории `scripts` и предназначены для автоматического выполнения задач по обслуживанию проекта: например, создание бэкапов. Для постановки скриптов на запуск по расписанию можно воспользоваться скриптом `tools/add_cron_jobs.sh`.

* `backup_database.py` - создать бэкап базы данных.
* `backup_storage.py` - создать бэкап загруженных файлов.

## Вспомогательные инструменты

Вспомогательные инструменты расположены в директории `tools` внутри корневой директории проекта. Предназначение данных скриптов - упрощение процесса разработки, развертывания и обслуживания проекта. Текущий набор вспомогательных скриптов включает в себя:

* `add_cron_jobs.sh` - добавить задачи в cron.
* `install_dependencies.sh` - установка зависимостей внутри проекта.
* `make_link.sh` - создать символическую ссылку на node_modules.
* `restart_services.sh` - перезапустить Gunicorn, Nginx и PostgreSQL.
* `restore_database.py` - восстановить базу данных из дампа.
* `run_server.sh` - запустить сервер в режиме разработки.
* `run_tests.sh` - провести тесты.
* `update_project.sh` - получить изменения и перезапустить сервер.
* `push_commit.sh` - отформатировать код и отправить коммит.

## Логирование

 В проекте используется стандартная библиотека логирования `logging`. Логи записываются в папку `logs` в корневой директории проекта с ежедневной ротацией файлов и хранением логов в течение недели.

## Тестирование

Проект использует несолько уровней тестирования:

* тестирование функциональности бэкэнда модулем `django.test`
* тестирование функциональности фронтенда модулем `node:test`

Для запуска тестов Python/Django можно воспользоваться командой:

    python manage.py test

Также проект подготовлен для тестирования при помощи Pytest:

    pytest

Запуск тестов при помощи Pytest является предпочтительным способом запуска тестов Python/Django. Настройки Pytest заданы в файле `pyproject.toml`. Подробнее о библиотеке Pytest: <https://docs.pytest.org/en/latest/>

Для запуска тестов Node.js можно воспользоваться командой:

    npm test

Также для выполнения всех тестов можно запустить bash-скрипт `run_tests.sh`:

    bash run_tests.sh

## Настройка ПО

### Подготовка базы данных PostgreSQL

Переключиться на учетную запись postgres:

    sudo -i -u postgres

Войти в интерпретатор PostgreSQL:

    psql

Создать пользователя:

    CREATE USER user WITH PASSWORD 'password';

Создать базу данных:

    CREATE DATABASE name OWNER user ENCODING 'UTF8';

Выйти из интерпретатора PostgreSQL:

    \q

Переключиться на стандартного пользователя:

    \exit

### Настройка certbot для обновления сертификата

Установить certbot:

    sudo apt install certbot python3-certbot-nginx

Получить SSL сертификат:

    sudo certbot --nginx -d example.com -d www.example.com

Проверить расписание обновления сертификата:

    sudo systemctl status certbot.timer

Проверить процесс обновления сертификата:

    sudo certbot renew --dry-run

## Решение проблем

### Ошибка 413 Request Entity Too Large

Для загрузки файлов большого размера через nginx необходимо установить соответствующее значение client_max_body_size в /etc/nginx/nginx.conf:

    sudo nano /etc/nginx/nginx.conf

Значение client_max_body_size указывается в блоке http:

    http {
        ...
        client_max_body_size = 25M;
        ...
    }

### Ошибка 500: unsupported locale setting

1. Выполнить команду `sudo dpkg-reconfigure locales`
2. Выбрать "ru_RU.UTF-8" в списке локалей.
3. Нажать `Enter`.
