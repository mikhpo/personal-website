# Руководство по разработке

## Управление зависимостями Python

Для управления зависимостями в проекте используется [Poetry](https://python-poetry.org/).

Файлы Poetry:

* `pyproject.toml` - описание проекта и список основных зависимостей.
* `poetry.toml` - конфигурация использования Poetry в проекте.
* `poetry.lock` - расширенный список зависимостей.

Зависимости также зафиксированы в `requirements.txt`.

Для установки зависимостей необходимо использовать команду:

    poetry install

Для обновления зависимостей можно воспользоваться пакетом `poetry-plugin-up`. Его необходимо установить при помощи команды `poetry self add poetry-plugin-up`. Запустить обновление зависимостей проекта можно следующей командой:

    poetry up --latest

Отличие этой команды от команды `poetry update` заключается в том, что она также приводит к обновлению версий пакетов в файле `pyproject.toml`.

Poetry сконфигурирован таким образом, чтобы виртуальное окружение создавалось в каталоге проекта. Если витуальное окружение ещё не создано, то после команды `poetry install` оно будет создано автоматически в папке `.venv`.

Для фиксации зависимостей в файле `requirements.txt` необходимо воспользоваться следующей командой:

    poetry export -f requirements.txt --output requirements.txt --without-hashes --with dev

В случае обновления релиза Python для обновления виртуального окружения необходимо после установки новой версии Python в систему использовать команду `poetry env use` с указанием версии Python. Например, чтобы переключиться на Python 3.12:

    poetry env use 3.12

Для обновления релиза Poetry необходимо использовать команду:

    poetry self update

## Секреты и переменные окружения

Для управления переменными окружения и секретами используется модуль [django-environ](https://django-environ.readthedocs.io/en/latest/index.html). Переменные окружения считываются из файла `.env`, который расположен в той же директории, что и `manage.py`. Данный файл исключен из Git-репозитория, но список используемых переменных окружения зафиксирован также в файле `.env.example`, который актуализируется вместе с `.env`.

## Запуск сервера

Для запуска сервера разработки можно применить команду:

    poetry run python personal_website/manage.py runserver

Предварительно активировать виртуальное окружение при этом не нужно. Однако можно запустить сервер разработки и традиционным способом - через предварительную активацию виртуального окружения:

    .venv/scripts/activate
    python personal_website/manage.py runserver

## Управление статическими файлами

Статические файлы - это CSS-библиотеки, JavaScript-модули, фавиконы и др. Все статические файлы собраны в каталоге `static`.

### Набор статических файлов

* `package.json` - описание основных Node.js зависимостей, обновляется автоматически через команды npm.
* `package-lock.json` - автообновляемый отчет, в котором фиксируется полный список npm-зависимостей и источников установки.
* `node_modules` - Node.js модули.
* `robots.txt` - файл управления допусками поисковых систем.
* `favicon.ico` - основной фавикон сайта. Также каталог содержит версии этого же фавикона в других размерах и расширениях под различные виды устройств.
* `staticfiles.json` - созданный библиотекой WhiteNoise манифест, в котором прописаны пути до всех статических файлов.
* `admin` - статические файлы административного интерфейса Django (CSS, JS, шрифты).
* `tinymce` - статические файлы WYSIWYG-редактора TinyMCE.
* `django_tinymce` - сторонний модуль, упрощающий интеграцию TinyMCE с Django.

### Установка статических файлов

Для установки Node.js зависимостей необходимо воспользоваться командой:

    npm install

Часть CSS и JS модулей, используемых пакетами Django, необходимо установить командой:

    python personal_website/manage.py collectstatic

## Тестирование

Проект использует несолько уровней тестирования:

* тестирование функциональности бэкэнда модулем `django.test`
* тестирование функциональности фронтенда модулем `node:test`

Для запуска тестов Python/Django можно воспользоваться командой:

    python manage.py test

Также проект подготовлен для тестирования при помощи Pytest:

    pytest

Запуск тестов при помощи Pytest является предпочтительным способом запуска тестов Python/Django. Настройки Pytest заданы в файле `pyproject.toml`. Подробнее о библиотеке Pytest: <https://docs.pytest.org/en/latest/>

Для запуска тестов Node.js можно воспользоваться командой:

    npm test

Также для выполнения всех тестов можно запустить bash-скрипт [runtests.sh](../tools/runtests.sh). Скрипт `runtests.sh` запускает тесты Node.js, тесты Pytest и создает отчет Coverage в формате HTML. Для запуска скрипта `runtests.sh` необходимо воспользоваться командой:

    bash tools/runtests.sh

Для запуска pytest в контейнере используется команда:

    docker compose exec website poetry run pytest

## Статический анализ

Проект применяет Ruff для статического анализа кода Python и ESLint для статического анализа кода JavaScript. Для конфигурации Ruff используется [pyproject.toml](../pyproject.toml), для конфигурации ESLint - [.eslintrc.json](../.eslintrc.json). Проверки Ruff включены в CI/CD пайплайн. Для вызова проверок Ruff вручную можно использовать команду:

    ruff check --fix

Для статического анализа типов для Python используется Mypy. Он позволяет находить ошибки несоответствия типов в коде. Для выполнения проверок Mypy можно выполнить команду:

    mypy .

## Контейнеризация

Проект использует Docker и Compose для контейнеризации. Настройки сборки приложения определены в [Dockerfile](../personal_website/Dockerfile), а в файле [compose.yaml](../compose.yaml) определены параметры запуска сервисов в контейнерах. Docker Compose поднимает следующие сервисы:

* Основное приложение Django
* База данных PostgreSQL
* Прокси-сервер Nginx

Для запуска контейнеров в интерактивном режиме можно использовать команду:

    docker compose up

Для запуска контейнеров в неинтерактивном режиме используется команда:

    docker compose up -d

Для сборки образов контейнеров без поднятия сервисов используется команда:

    docker compose build

Для отслеживания изменений и автоматического пересоздания контейнеров в режиме разработки можно использовать команду:

    docker compose up -d && docker compose watch

Для удаления контейнеров и вспомогательных ресурсов (томов, сетей) используется команда:

    docker compose down

## Вспомогательные сервисы

### PostgreSQL

#### Использование PostgreSQL в контейнере

При создании контейнера с кластером базы данных [PostgreSQL](https://www.postgresql.org/) на основе [официального образа postgres](https://hub.docker.com/_/postgres) база данных создается автоматически в соответствии со значениями переменных окружения `POSTGRES_USER`, `POSTGRES_PASSWORD` и `POSTGRES_DB`, указанными в файле [compose.yaml](../compose.yaml). Для подключения к базе данных необходимо использовать имя хоста `postgres`, если сервис, из которого производится переключение, также запускается при помощи Docker Compose, и имя хоста `localhost` в случаях, если сервис запускается на том же хосте, но не через Docker Compose.

#### Ручное создание базы данных PostgreSQL

Переключиться на учетную запись postgres:

    sudo -i -u postgres

Войти в интерпретатор PostgreSQL:

    psql

Создать пользователя:

    CREATE USER user WITH PASSWORD 'password';

Создать базу данных:

    CREATE DATABASE name OWNER user ENCODING 'UTF8';

Выйти из интерпретатора PostgreSQL:

    \q

Переключиться на стандартного пользователя:

    \exit

### Nginx и Certbot

Для создания контейнера с [Nginx](https://nginx.org/ru/) испольузется [официальный образ nginx](https://hub.docker.com/_/nginx), в который дополнительно устанавливается [Certbot](https://certbot.eff.org/). При создании контейнера применяется утилита `envsubst`, которая заполняет шаблон файла конфигурации nginx значениями переменных окружения, считанных из `.env` файла. Шаблоны конфигурационных файлов должны храниться в каталоге [nginx/templates/](../nginx/templates/).

Certbot используется для получения и обновления сертификатов. Для первичного получения сертификата [Let's Encrypt](https://letsencrypt.org/) со сроком действия 90 дней и изменения конфигурации nginx для включения HTTPS необходимо выполнить команду:

    docker compose run nginx bash certbot.sh

Команда для обновления сертификата установливается автоматически в cron для запуска каждые 12 часов. Фактическое обновление сертификатов производится только в том случае, если остается менее 30 дней до срока окончания действия текущего сертификата.

Для ручного обновления сертификата можно выполнить команду:

    docker compose run nginx certbot renew

## Хуки в Git

Проект использует хуки в Git для подготовки коммита, автоматической проверки и форматирования кода.

Для ручного запуска хуков [pre-commit](https://pre-commit.com/) можно использовать команду:

    pre-commit run --all-files

Для обновления конфигураций хуков можно использовать команду:

    pre-commit autoupdate

## Использование Task

Проект использует утилиту [Task](https://taskfile.dev/) для упрощения запуска команд по управлению процессом разработки, развертыванию и администрированию проектом. Список команд определн в файле [Taskfile.yml](./Taskfile.yml), расположенном в корневом каталоге проекта. Для установки Task на macOS можно использовать команду:

    brew install go-task/tap/go-task

Альтернативные варианты установки Task [описаны в документации](https://taskfile.dev/installation/).

Для просмотра списка доступных команд можно использовать команду:

    task -l

Вызвать какую-либо команду можно следующим способом:

    task <command>

Для показа подробного описания описания команды можно ввести:

    task --summary <command>

## Развертывание

Общий порядок действий:

1. Установить Git командой `sudo apt-get update && sudo apt-get install -y git`
1. На целевом хосте создать ключ SSH и добавить в профиль в GitHub
1. Сменить рабочую директорию на `/srv`
1. Клонировать исходный код на целевой хост: `git clone git@github.com:<project-name>/personal-website.git`
1. Сменить рабочую директорию на `/srv/personal-website`
1. Заполнить файл .env с конфигурационными параметрами: `nano .env`
1. Запустить скрипт для развертывания:
    * `bash personal_website/scripts/docker/deploy.sh` для развертывания в контейнере
    * `bash personal_website/scripts/server/deploy.sh` для развертывание в ОС хоста

### Добавление SSH-ключей хоста в GitHub

Добавление SSH-ключа хоста в профиль GitHub требуется для выполнения команд `git clone`, `git pull` и т.д.

1. Проверить существующие ключи: `ls -al ~/.ssh`
1. Создать новый ключ: `ssh-keygen -t ed25519 -C "Personal Website Deployment"`
1. Скопировать новый ключ: `cat ~/.ssh/id_ed25519.pub`
1. Добавить ключ в настройки профиля GitHub: <https://github.com/settings/ssh/new>

## Логирование

 В проекте используется стандартная библиотека логирования `logging`. Логи записываются в папку `logs` в корневой директории проекта с ежедневной ротацией файлов и хранением логов в течение недели.

## Генерация схем моделей

Для генерации схемы модели данных можно использовать команду [graph_models](https://django-extensions.readthedocs.io/en/latest/graph_models.html) библиотеки [django-extensions](https://django-extensions.readthedocs.io/en/latest/). Для выполнения команды в системе должен быть установлен пакет [Graphviz](https://www.graphviz.org/). Пример установки для macOS:

    brew install graphviz

Пример генерации схемы моделей всех приложений проекта в формате PNG:

    poetry run python personal_website/manage.py graph_models -a -g -o docs/images/project_models.png

В связи с тем, что имеет смысл создавать диаграммы разного уровня детализации (для проекта, приложений, каждого приложения), целесообразнее запускать скрипт [graphmodels.sh](../tools/graphmodels.sh) для генерации диаграмм моделей:

    bash tools/graphmodels.sh

## Решение проблем

### Ошибка 413 Request Entity Too Large

Для загрузки файлов большого размера через nginx необходимо установить соответствующее значение client_max_body_size в /etc/nginx/nginx.conf:

    sudo nano /etc/nginx/nginx.conf

Значение client_max_body_size указывается в блоке http:

    http {
        ...
        client_max_body_size = 25M;
        ...
    }

### Ошибка 500: unsupported locale setting

1. Выполнить команду `sudo dpkg-reconfigure locales`
2. Выбрать "ru_RU.UTF-8" в списке локалей.
3. Нажать `Enter`.

### Предупреждение WARN[0000] при выполнении команд Docker

Ошибка возникает при считывании переменных из файла .env, если переменные окружения заключены в двойные кавычки. Решением является заменить двойные кавычки на одинарные.
